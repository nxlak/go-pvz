version: '3'

# –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç–∞
vars:
  GO_VERSION: '1.25.3'
  GOLANGCI_LINT_VERSION: 'v2.6.2'
  GCI_VERSION: 'v0.13.7'
  GOFUMPT_VERSION: 'v0.9.2'
  OGEN_VERSION: 'v1.18.0'
  YQ_VERSION: 'v4.49.2'
  BUF_VERSION: '1.61.0'
  PROTOC_GEN_GO_VERSION: 'v1.36.6'
  PROTOC_GEN_GO_GRPC_VERSION: 'v1.5.1'
  PROTOC_GEN_GRPC_GATEWAY_VERSION: 'v2.26.3'
  PROTOC_GEN_VALIDATE_VERSION: 'v1.2.1'
  PROTOC_GEN_OPENAPIV2_VERSION: 'v2.26.3'

  # –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –ø—É—Ç–∏, —á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞—Ç—å Windows-–ø—É—Ç–∏
  BIN_DIR: './bin'
  GOLANGCI_LINT: '{{.BIN_DIR}}/golangci-lint'
  GCI: '{{.BIN_DIR}}/gci'
  GOFUMPT: '{{.BIN_DIR}}/gofumpt'
  OGEN: '{{.BIN_DIR}}/ogen'
  YQ: '{{.BIN_DIR}}/yq'
  BUF: '{{.BIN_DIR}}/buf'
  PROTOC_GEN_GO: '{{.BIN_DIR}}/protoc-gen-go'
  PROTOC_GEN_GO_GRPC: '{{.BIN_DIR}}/protoc-gen-go-grpc'
  PROTOC_GEN_GRPC_GATEWAY: '{{.BIN_DIR}}/protoc-gen-grpc-gateway'
  PROTOC_GEN_VALIDATE: '{{.BIN_DIR}}/protoc-gen-validate'
  PROTOC_GEN_OPENAPIV2: '{{.BIN_DIR}}/protoc-gen-openapiv2'

  PROTO_DIR: './proto'

  OPEN_API_ORDER_V1_BASE: './api/order/v1/order.openapi.yaml'
  OPEN_API_ORDER_V1_BUNDLE: './api/bundles/order.openapi.v1.bundle.yaml'
  OPEN_API_FILES: './api/bundles'

tasks:
  install-formatters:
    desc: "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ñ–æ—Ä–º–∞—Ç—Ç–µ—Ä—ã gci –∏ gofumpt –≤ ./bin"
    cmds:
      - |
        [ -f {{.GOFUMPT}} ] || {
          echo 'üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º gofumpt {{.GOFUMPT_VERSION}}...'
          mkdir -p {{.BIN_DIR}}
          go install mvdan.cc/gofumpt@{{.GOFUMPT_VERSION}}
        }
      - |
        [ -f {{.GCI}} ] || {
          echo 'üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º gci {{.GCI_VERSION}}...'
          mkdir -p {{.BIN_DIR}}
          go install github.com/daixiang0/gci@{{.GCI_VERSION}}
        }
    status:
      - test -x {{.GOFUMPT}}
      - test -x {{.GCI}}

  format:
    desc: "–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –≤–µ—Å—å –ø—Ä–æ–µ–∫—Ç gofumpt + gci"
    deps: [ install-formatters ]
    cmds:
      - |
        echo "üßº –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —á–µ—Ä–µ–∑ gofumpt ..."
        find . -type f -name '*.go' ! -path '*/mocks/*' -exec {{.GOFUMPT}} -extra -w {} +
      - |
        echo "üéØ –°–æ—Ä—Ç–∏—Ä—É–µ–º –∏–º–ø–æ—Ä—Ç—ã —á–µ—Ä–µ–∑ gci ..."
        find . -type f -name '*.go' ! -path '*/mocks/*' -exec {{.GCI}} write -s standard -s default -s "prefix(github.com/olezhek28/microservices-course-examples/)" {} +

  install-golangci-lint:
    desc: "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç golangci-lint –≤ –∫–∞—Ç–∞–ª–æ–≥ bin"
    cmds:
      - |
        [ -f {{.GOLANGCI_LINT}} ] || {
          echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º golangci-lint {{.GOLANGCI_LINT_VERSION}}..."
          mkdir -p {{.BIN_DIR}}
          go install github.com/golangci/golangci-lint/v2/cmd/golangci-lint@{{.GOLANGCI_LINT_VERSION}}
        }
    status:
      - test -x {{.GOLANGCI_LINT}}

  lint:
    desc: "–ó–∞–ø—É—Å–∫–∞–µ—Ç golangci-lint –¥–ª—è –≤—Å–µ—Ö –º–æ–¥—É–ª–µ–π"
    deps: [ install-golangci-lint ]
    cmds:
      - '{{.GOLANGCI_LINT}} run ./... --config=.golangci.yml'

  redocly-cli:install:
    desc: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ Redocly CLI
    cmds:
      - |
        echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º redocly-cli (npm install)..."
        npm install

  redocly-cli:order-v1-bundle:
    desc: –°–æ–±—Ä–∞—Ç—å OpenAPI –≤ –æ–¥–∏–Ω —Ñ–∞–π–ª —á–µ—Ä–µ–∑ redocly (npx)
    deps: [ redocly-cli:install ]
    cmds:
      - npx @redocly/cli bundle {{.OPEN_API_ORDER_V1_BASE}} -o {{.OPEN_API_ORDER_V1_BUNDLE}}

  redocly-cli:bundle:
    desc: –°–æ–±—Ä–∞—Ç—å –≤—Å–µ —Å—Ö–µ–º—ã OpenAPI –≤ –æ–±—â–∏–µ —Ñ–∞–π–ª—ã —á–µ—Ä–µ–∑ redocly
    cmds:
      - task: redocly-cli:order-v1-bundle

  ogen:install:
    desc: "–°–∫–∞—á–∏–≤–∞–µ—Ç ogen –≤ –ø–∞–ø–∫—É bin"
    cmds:
      - |
        [ -f {{.OGEN}} ] || {
          echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º ogen {{.OGEN_VERSION}}..."
          mkdir -p {{.BIN_DIR}}
          go install github.com/ogen-go/ogen/cmd/ogen@{{.OGEN_VERSION}}
        }

  ogen:gen:
    desc: "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è Go-–∫–æ–¥–∞ –∏–∑ –≤—Å–µ—Ö OpenAPI-–¥–µ–∫–ª–∞—Ä–∞—Ü–∏–π —Å x-ogen"
    deps: [ ogen:install, yq:install ]
    cmds:
      - task: redocly-cli:bundle
      - |
        for ext in yaml yml; do
          find {{.OPEN_API_FILES}} -name "*.${ext}" | while read -r file; do
            if [ -f "$file" ]; then
              has_ogen=$({{.YQ}} e 'has("x-ogen")' "$file")
              if [ "$has_ogen" = "true" ]; then
                echo "üöÄ Generating from: $file"
                target=$({{.YQ}} e '."x-ogen".target' "$file")
                package=$({{.YQ}} e '."x-ogen".package' "$file")
                echo "üìÅ Target: $target"
                echo "üì¶ Package: $package"
                {{.OGEN}} \
                  --target "$target" \
                  --package "$package" \
                  --clean \
                  "$file" || exit 1
              fi
            fi
          done
        done

  yq:install:
    desc: "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç yq –≤ bin/ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏"
    cmds:
      - |
        [ -f {{.YQ}} ] || {
          echo 'üì¶ Installing yq...'
          mkdir -p {{.BIN_DIR}}
          go install github.com/mikefarah/yq/v4@{{.YQ_VERSION}}
        }
    status:
      - test -x {{.YQ}}

  install-buf:
    desc: "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç Buf –≤ –∫–∞—Ç–∞–ª–æ–≥ bin"
    cmds:
      - |
        [ -f {{.BUF}} ] || {
          echo 'üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º buf {{.BUF_VERSION}}...'
          mkdir -p {{.BIN_DIR}}
          go install github.com/bufbuild/buf/cmd/buf@v{{.BUF_VERSION}}
        }
    status:
      - test -x {{.BUF}}

  proto:install-plugins:
    desc: "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç protoc –ø–ª–∞–≥–∏–Ω—ã –≤ –∫–∞—Ç–∞–ª–æ–≥ bin"
    cmds:
      - |
        [ -f {{.PROTOC_GEN_GO}} ] || {
          echo 'üì¶ Installing protoc-gen-go {{.PROTOC_GEN_GO_VERSION}}...'
          mkdir -p {{.BIN_DIR}}
          go install google.golang.org/protobuf/cmd/protoc-gen-go@{{.PROTOC_GEN_GO_VERSION}}
        }
        [ -f {{.PROTOC_GEN_GO_GRPC}} ] || {
          echo 'üì¶ Installing protoc-gen-go-grpc {{.PROTOC_GEN_GO_GRPC_VERSION}}...'
          mkdir -p {{.BIN_DIR}}
          go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@{{.PROTOC_GEN_GO_GRPC_VERSION}}
        }
        [ -f {{.PROTOC_GEN_GRPC_GATEWAY}} ] || {
          echo 'üì¶ Installing protoc-gen-grpc-gateway {{.PROTOC_GEN_GRPC_GATEWAY_VERSION}}...'
          mkdir -p {{.BIN_DIR}}
          go install github.com/grpc-ecosystem/grpc-gateway/v2/protoc-gen-grpc-gateway@{{.PROTOC_GEN_GRPC_GATEWAY_VERSION}}
        }
        [ -f {{.PROTOC_GEN_VALIDATE}} ] || {
          echo 'üì¶ Installing protoc-gen-validate...'
          mkdir -p {{.BIN_DIR}}
          go install github.com/envoyproxy/protoc-gen-validate@{{.PROTOC_GEN_VALIDATE_VERSION}}
        }
        [ -f {{.PROTOC_GEN_OPENAPIV2}} ] || {
          echo 'üì¶ Installing protoc-gen-openapiv2...'
          mkdir -p {{.BIN_DIR}}
          go install github.com/grpc-ecosystem/grpc-gateway/v2/protoc-gen-openapiv2@{{.PROTOC_GEN_OPENAPIV2_VERSION}}
        }
    status:
      - test -x {{.PROTOC_GEN_GO}}
      - test -x {{.PROTOC_GEN_GO_GRPC}}
      - test -x {{.PROTOC_GEN_GRPC_GATEWAY}}
      - test -x {{.PROTOC_GEN_VALIDATE}}
      - test -x {{.PROTOC_GEN_OPENAPIV2}}

  proto:deps:
    deps: [ install-buf ]
    desc: "–û–±–Ω–æ–≤–∏—Ç—å buf.lock –∏ –ø–æ–¥—Ç—è–Ω—É—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (buf dep update)"
    dir: "{{.PROTO_DIR}}"
    cmds:
      - |
        echo "üìå Update buf deps..."
        PATH="../bin:$PATH" ../bin/buf dep update .

  proto:lint:
    deps: [ proto:deps, proto:install-plugins ]
    desc: "–ü—Ä–æ–≤–µ—Ä–∫–∞ .proto-—Ñ–∞–π–ª–æ–≤ –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å—Ç–∏–ª—é (buf lint)"
    dir: "{{.PROTO_DIR}}"
    cmds:
      - |
        echo "üîé Lint proto files (buf)..."
        PATH="../bin:$PATH" ../bin/buf lint .

  proto:gen:
    deps: [ proto:deps, proto:install-plugins, proto:lint ]
    desc: "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è Go-–∫–æ–¥–∞ –∏–∑ .proto (buf generate)"
    dir: "{{.PROTO_DIR}}"
    cmds:
      - |
        echo "üöÄ Generate gRPC (buf)..."
        PATH="../bin:$PATH" ../bin/buf generate